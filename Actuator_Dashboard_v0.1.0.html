<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBS Haptic Actuators</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- GLOBAL STYLES --- */
        body { font-family: 'Segoe UI', sans-serif; background: #eef2f5; padding: 20px; text-align: center; }
        
        header { margin-bottom: 30px; }
        h1 { margin: 0; color: #333; }
        
        /* MQTT Connection Status Indicator */
        #status { font-weight: bold; color: #dc3545; font-size: 14px; margin-top: 5px; }
        #status.connected { color: #28a745; }

        /* --- DASHBOARD GRID LAYOUT --- */
        .dashboard-grid {
            display: grid;
            /* Auto-fit: Creates as many columns as fit, min width 320px */
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* --- DEVICE CARD STYLING --- */
        .device-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: space-between; 
            border: 2px solid transparent;
            transition: border-color 0.3s;
        }
        
        /* Visual cue: Orange border when controlled via USB */
        .device-card.usb-active { border-color: #fd7e14; }

        .card-header {
            background: #343a40;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .device-name { font-weight: bold; font-size: 1.1em; }
        .device-id { font-size: 0.8em; color: #adb5bd; }

        /* --- USB BUTTON STATES --- */
        .usb-btn {
            background: transparent;
            border: 1px solid #adb5bd;
            color: #adb5bd;
            border-radius: 4px;
            padding: 2px 8px;
            font-size: 0.8em;
            cursor: pointer;
            margin-left: 10px;
        }
        .usb-btn:hover { color: white; border-color: white; }
        
        /* State: Connected (Orange) */
        .usb-btn.connected { background: #fd7e14; border-color: #fd7e14; color: white; }
        
        /* State: Handshaking (Square shape for spinner) */
        .usb-btn.square {
            width: 28px;       
            height: 28px;      
            padding: 0;        
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px; 
        }

        .file-list {
            padding: 15px;
            flex-grow: 1;
            min-height: 150px;
        }
        
        /* --- STOP BUTTON --- */
        .card-stop-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            margin: 0 15px 20px 15px;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(220, 53, 69, 0.3);
        }
        .card-stop-btn:hover { 
            background: #c82333; 
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.4);
        }
        .card-stop-btn:active { transform: translateY(0); }

        .loading-text { color: #888; font-style: italic; margin-top: 50px; }

        /* --- FILE LIST ROWS --- */
        .file-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 6px;
        }
        .file-name { font-size: 14px; color: #495057; font-weight: 500; }

        .btn-group { display: flex; gap: 5px; }
        .icon-btn {
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.1s;
        }
        .icon-btn:active { transform: scale(0.95); }
        .btn-play { background: #0d6efd; } 
        .btn-play:hover { background: #0b5ed7; }
        .btn-loop { background: #0d6efd; } 
        .btn-loop:hover { background: #0b5ed7; }

        /* --- VOLUME CONTROLS --- */
        .volume-container {
            padding: 0 15px 15px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .volume-label {
            font-size: 12px;
            color: #6c757d;
            font-weight: bold;
            min-width: 30px;
        }
        input[type=range] {
            flex-grow: 1;
            cursor: pointer;
        }

        /* Utility to hide Stop/Volume until device connects */
        .hidden-controls { display: none !important; }
        .refresh-all { margin-top: 30px; display: inline-block; cursor: pointer; color: #0d6efd; text-decoration: underline; }
    </style>
</head>
<body>

<header>
    <h1>SBS Haptic Actuators</h1>
    <div id="status">MQTT Disconnected</div>
</header>

<div id="dashboard" class="dashboard-grid"></div>

<div class="refresh-all" onclick="requestAllFiles()">Refresh All Device Lists</div>

<script>
    // =================================================================
    // CONFIGURATION
    // =================================================================
    // Define your devices here. 
    // 'baseTopic' must match the device's firmware settings.
    const devices = [
        { name: "Tentacle 1", baseTopic: "SBShaptics/1", mode: 'MQTT', serialWriter: null, poller: null, port: null, reader: null, isBusy: false },
        { name: "Tentacle 2", baseTopic: "SBShaptics/2", mode: 'MQTT', serialWriter: null, poller: null, port: null, reader: null, isBusy: false },
        { name: "Tentacle 3", baseTopic: "SBShaptics/3", mode: 'MQTT', serialWriter: null, poller: null, port: null, reader: null, isBusy: false },
        { name: "Tentacle 4", baseTopic: "SBShaptics/4", mode: 'MQTT', serialWriter: null, poller: null, port: null, reader: null, isBusy: false },  
        { name: "Tentacle 5", baseTopic: "SBShaptics/5", mode: 'MQTT', serialWriter: null, poller: null, port: null, reader: null, isBusy: false },
        { name: "Tentacle 6", baseTopic: "SBShaptics/6", mode: 'MQTT', serialWriter: null, poller: null, port: null, reader: null, isBusy: false },
    ];

    const mqtt_server = "broker.emqx.io";
    const mqtt_port = 8083; // Websocket port (not 1883)
    // Generate unique ID to prevent conflicts
    const clientID = "TitanWeb-" + Math.floor(Math.random() * 100000);
    const client = new Paho.MQTT.Client(mqtt_server, mqtt_port, clientID);

    // =================================================================
    // UI GENERATION
    // =================================================================
    function initDashboard() {
        const container = document.getElementById('dashboard');
        
        // Loop through config array and create HTML card for each device
        devices.forEach((device, index) => {
            const card = document.createElement('div');
            card.className = 'device-card';
            card.id = `card-${index}`;
            
            // Sanitize topic for use as HTML ID (replace '/' with '-')
            const safeId = device.baseTopic.replace(/\//g, '-');
            
            card.innerHTML = `
                <div class="card-header">
                    <div>
                        <span class="device-name"><i class="fas fa-microchip"></i> ${device.name}</span>
                        <div class="device-id">${device.baseTopic}</div>
                    </div>
                    <button class="usb-btn" id="usb-btn-${index}" onclick="toggleUsb(${index})" title="Connect/Disconnect USB">
                        <i class="fab fa-usb"></i> USB
                    </button>
                </div>
                
                <div id="list-${safeId}" class="file-list">
                    <div class="loading-text">Waiting for device...</div>
                </div>

                <div id="vol-box-${safeId}" class="volume-container hidden-controls">
                    <i class="fas fa-volume-down" style="color:#6c757d"></i>
                    <input type="range" min="0" max="100" value="100" 
                           oninput="updateVolLabel('${safeId}', this.value)"
                           onchange="sendVolume('${device.baseTopic}', this.value)">
                    <span id="vol-lbl-${safeId}" class="volume-label">100%</span>
                </div>

                <button id="stop-btn-${safeId}" class="card-stop-btn hidden-controls" onclick="sendCommand('${device.baseTopic}', 'stop')">
                    <i class="fas fa-stop-circle"></i> STOP AUDIO
                </button>
            `;
            container.appendChild(card);
        });
    }

    // =================================================================
    // MQTT LOGIC (WIFI)
    // =================================================================
    client.onConnectionLost = (resp) => {
        console.log("MQTT Lost connection", resp);
        document.getElementById("status").innerText = "MQTT Disconnected";
        document.getElementById("status").className = "";
    };

    client.onMessageArrived = (msg) => {
        const topic = msg.destinationName;
        const payload = msg.payloadString; // Expected CSV: "file1.wav,file2.wav"
        
        // Find which device this message belongs to
        const device = devices.find(d => topic.includes(d.baseTopic));
        
        // Only update UI if device is in 'MQTT' mode (ignore if USB is active)
        if (device && topic.endsWith("/files") && device.mode === 'MQTT') {
            renderFileList(device, payload);
        }
    };

    // Connect to Broker
    client.connect({
        onSuccess: () => {
            console.log("MQTT Connected");
            const el = document.getElementById("status");
            el.innerText = "MQTT Connected";
            el.className = "connected";
            
            // Subscribe to all file lists
            devices.forEach(d => { client.subscribe(d.baseTopic + "/files"); });
            
            // Ask devices to report their files
            setTimeout(requestAllFiles, 1000);
        },
        onFailure: (e) => { console.log("Connect failed", e); }
    });

    // =================================================================
    // WEB SERIAL LOGIC (USB)
    // =================================================================

    /**
     * Main handler for USB button click.
     * Logic: Connect -> (Busy/Connecting) -> Disconnect
     */
    async function toggleUsb(index) {
        const device = devices[index];
        const btn = document.getElementById(`usb-btn-${index}`);

        // 1. CANCELLATION LOGIC
        // If the spinner is spinning, the user is aborting the connection attempt
        if (device.isBusy) {
            console.log("Canceling connection attempt...");
            await disconnectUsb(index);
            return;
        }

        // 2. DISCONNECT LOGIC
        if (device.mode === 'USB') {
            await disconnectUsb(index);
        } else {
            // 3. CONNECT LOGIC
            // Set Busy Flag to prevent duplicate clicks while popup is open
            device.isBusy = true;
            
            // Update UI to Spinner
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>';
            btn.classList.add("square"); 
            btn.classList.add("connected"); 

            await connectUsb(index);
        }
    }

    /**
     * Opens Serial Port and starts Streams
     */
    async function connectUsb(deviceIndex) {
        const device = devices[deviceIndex];
        const btn = document.getElementById(`usb-btn-${deviceIndex}`);

        if (!navigator.serial) {
            alert("Web Serial not supported in this browser (Use Chrome/Edge).");
            resetButton(deviceIndex);
            return;
        }

        try {
            // Opens the browser permission prompt (must be user-triggered)
            const port = await navigator.serial.requestPort();
            
            // Prevent error if port was not closed properly before
            if (port.readable || port.writable) {
                 console.log("Port already open, reusing...");
            } else {
                 await port.open({ baudRate: 115200 });
            }

            // Update Device State
            device.mode = 'USB'; 
            device.port = port; 
            document.getElementById(`card-${deviceIndex}`).classList.add("usb-active");

            // Setup Write Stream (Browser -> ESP32)
            const textEncoder = new TextEncoderStream();
            const writableStreamClosed = textEncoder.readable.pipeTo(port.writable);
            device.serialWriter = textEncoder.writable.getWriter();

            // Setup Read Stream (ESP32 -> Browser)
            const textDecoder = new TextDecoderStream();
            const readableStreamClosed = port.readable.pipeTo(textDecoder.writable);
            const reader = textDecoder.readable.getReader();
            device.reader = reader; 

            // Start listening for incoming data
            readSerialLoop(reader, device);

            // Start Polling (Handshake)
            // We repeatedly ask for the "list" until the ESP32 responds
            console.log("Port open. Starting handshake...");
            device.poller = setInterval(() => {
                if(device.mode === 'USB') {
                    sendCommand(device.baseTopic, "list");
                }
            }, 2000);

        } catch (error) {
            console.error("USB Connect Error:", error);
            // Cleanup if user cancelled or error occurred
            await disconnectUsb(deviceIndex);
            
            if (!error.message.includes("No port selected")) {
                alert("Connection failed: " + error.message);
            }
        }
    }

    /**
     * Closes ports, stops streams, and resets UI
     */
    async function disconnectUsb(index) {
            const device = devices[index];
            
            // Stop the handshake interval
            if (device.poller) {
                clearInterval(device.poller);
                device.poller = null;
            }

            // Close Streams (Required to release the USB hardware)
            try {
                if (device.reader) {
                    await device.reader.cancel(); 
                    device.reader = null;
                }
                if (device.serialWriter) {
                    await device.serialWriter.close();
                    device.serialWriter = null;
                }
                if (device.port) {
                    await device.port.close();
                    device.port = null;
                }
            } catch (e) {
                console.log("Cleanup warning (stream might already be closed):", e);
            }

            // Reset Device Logic State
            device.mode = 'MQTT';
            device.isBusy = false; 

            // Reset UI State
            resetButton(index);
            document.getElementById(`card-${index}`).classList.remove("usb-active");

            const safeId = device.baseTopic.replace(/\//g, '-');
            document.getElementById(`list-${safeId}`).innerHTML = '<div class="loading-text">Waiting for device...</div>';
            
            // Hide controls so user can't click them while disconnected
            document.getElementById(`vol-box-${safeId}`).classList.add('hidden-controls');
            document.getElementById(`stop-btn-${safeId}`).classList.add('hidden-controls');
            
            // Attempt to fall back to MQTT (WiFi)
            setTimeout(() => sendCommand(device.baseTopic, "list"), 500);
            
            console.log(`Device ${index} disconnected.`);
        }

    // Helper: Resets USB button appearance
    function resetButton(index) {
        const btn = document.getElementById(`usb-btn-${index}`);
        btn.innerHTML = '<i class="fab fa-usb"></i> USB';
        btn.classList.remove("connected");
        btn.classList.remove("square"); 
    }

    /**
     * Reads line-by-line from USB
     */
    async function readSerialLoop(reader, device) {
        let buffer = "";
        try {
            while (true) {
                const { value, done } = await reader.read();
                if (done) break; 
                buffer += value;
                
                // Process complete lines
                let lines = buffer.split("\n");
                buffer = lines.pop(); // Keep incomplete fragment in buffer

                for (let line of lines) {
                    line = line.trim();
                    if (line.length > 0) {
                        // Check for specific prefix defined in ESP32 code
                        if (line.startsWith("FILES:")) {
                            
                            // Handshake Complete!
                            if(device.poller) {
                                clearInterval(device.poller);
                                device.poller = null;
                                device.isBusy = false; // Allow user to click button again

                                // Update Button to Checkmark
                                const index = devices.indexOf(device);
                                const btn = document.getElementById(`usb-btn-${index}`);
                                btn.innerHTML = '<i class="fas fa-check"></i>';
                                btn.classList.add("square");
                            }
                            
                            // Remove prefix and render UI
                            renderFileList(device, line.substring(6));
                        }
                    }
                }
            }
        } catch (error) { 
            console.log("Read loop ended"); 
        }
    }

    // =================================================================
    // COMMON HELPERS
    // =================================================================
    
    // Refresh all devices via MQTT
    function requestAllFiles() {
        devices.forEach(d => {
            sendCommand(d.baseTopic, "list");
            const safeId = d.baseTopic.replace(/\//g, '-');
            const listDiv = document.getElementById(`list-${safeId}`);
            if(listDiv) listDiv.innerHTML = '<div class="loading-text">Refreshing...</div>';
        });
    }

    // Convert CSV list (file1.wav,file2.wav) into Buttons
    function renderFileList(device, csv) {
        const safeId = device.baseTopic.replace(/\//g, '-');
        const listDiv = document.getElementById(`list-${safeId}`);
        
        // Show controls now that we have connection
        document.getElementById(`vol-box-${safeId}`).classList.remove('hidden-controls');
        document.getElementById(`stop-btn-${safeId}`).classList.remove('hidden-controls');

        listDiv.innerHTML = ""; 

        if (!csv || csv.length === 0) {
            listDiv.innerHTML = '<p style="color:#888">No files found.</p>';
            return;
        }

        const files = csv.split(",");
        files.forEach(file => {
            const row = document.createElement('div');
            row.className = 'file-row';
            row.innerHTML = `
                <span class="file-name">${file}</span>
                <div class="btn-group">
                    <button class="icon-btn btn-play" title="Play Once" onclick="sendCommand('${device.baseTopic}', '${file}')">
                        <i class="fas fa-play"></i>
                    </button>
                    <button class="icon-btn btn-loop" title="Loop" onclick="sendCommand('${device.baseTopic}', 'loop:${file}')">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            `;
            listDiv.appendChild(row);
        });
    }

    // Route commands to the active transport layer (USB or MQTT)
    async function sendCommand(topic, msg) {
        const device = devices.find(d => d.baseTopic === topic);
        if (!device) return;

        if (device.mode === 'USB' && device.serialWriter) {
            // Send via Serial Stream
            try {
                await device.serialWriter.write(msg + "\r\n");
            } catch(e) { console.error("Write error:", e); }
        } else {
            // Send via Websocket MQTT
            if (client.isConnected()) {
                const message = new Paho.MQTT.Message(msg);
                message.destinationName = topic;
                client.send(message);
            }
        }
    }

    function updateVolLabel(safeId, val) {
        document.getElementById(`vol-lbl-${safeId}`).innerText = val + "%";
    }

    function sendVolume(topic, val) {
        sendCommand(topic, "vol:" + val);
    }

    // Start the app
    initDashboard();
</script>
</body>
</html>